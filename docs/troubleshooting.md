# 故障排除

本文档提供了 AstrBot AI 图像生成插件的常见问题和解决方案，帮助您快速解决使用中遇到的问题。

## 目录

- [概述](#概述)
- [安装问题](#安装问题)
- [配置问题](#配置问题)
- [使用问题](#使用问题)
- [错误代码](#错误代码)
- [性能问题](#性能问题)
- [获取帮助](#获取帮助)

## 概述

如果您在使用插件时遇到问题，请按照以下步骤排查：

1. 📖 查看本文档的相关章节
2. 🔍 检查插件日志
3. ✅ 验证配置是否正确
4. 🔄 尝试重启 AstrBot
5. 💬 在 GitHub Issues 中提问

## 安装问题

### 问题 1：插件安装失败

**症状**：
- 在插件市场安装时显示错误
- 手动安装后插件无法加载

**可能原因**：
- AstrBot 版本过低
- Python 版本不兼容
- 依赖包未安装
- 文件权限问题

**解决方案**：

1. **检查 AstrBot 版本**：
   ```
   要求：AstrBot 2.8.0 或更高版本
   ```

2. **检查 Python 版本**：
   ```bash
   python --version
   # 建议：Python 3.10 或更高版本
   ```

3. **安装依赖包**：
   ```bash
   pip install -r requirements.txt
   ```

4. **检查文件权限**：
   ```bash
   chmod -R 755 data/plugins/astrbot_plugin_models_ai
   ```

5. **查看日志**：
   - 打开 AstrBot 管理后台
   - 进入「日志」页面
   - 查找插件相关的错误信息

---

### 问题 2：插件加载失败

**症状**：
- 插件显示为「加载失败」
- 控制台显示错误信息

**常见错误信息**：
```
ModuleNotFoundError: No module named 'xxx'
ImportError: cannot import name 'xxx'
```

**解决方案**：

1. **检查依赖包**：
   ```bash
   cd /path/to/AstrBot/data/plugins/astrbot_plugin_models_ai
   pip install -r requirements.txt
   ```

2. **检查 Python 路径**：
   - 确保 AstrBot 使用的 Python 环境与安装依赖的环境一致
   - 可能需要使用虚拟环境

3. **重新安装插件**：
   ```bash
   # 删除旧版本
   rm -rf data/plugins/astrbot_plugin_models_ai
   
   # 重新安装
   git clone https://github.com/xiaomizhoubaobei/astrbot_plugin_models_ai.git data/plugins/astrbot_plugin_models_ai
   ```

4. **重启 AstrBot**：
   ```bash
   # 停止 AstrBot
   # 重新启动 AstrBot
   ```

---

### 问题 3：插件命令无法识别

**症状**：
- 发送 `/ai-gitee help` 没有响应
- 显示「未知命令」错误

**可能原因**：
- 插件未正确加载
- 命令注册失败
- 插件被禁用

**解决方案**：

1. **检查插件状态**：
   - 打开 AstrBot 管理后台
   - 进入「插件管理」页面
   - 确认插件状态为「已启用」

2. **检查命令注册**：
   - 查看插件日志
   - 确认命令是否成功注册

3. **重新加载插件**：
   - 在插件管理页面点击「重新加载」
   - 或重启 AstrBot

4. **检查命令格式**：
   - 确保使用正确的命令格式：`/ai-gitee help`
   - 注意命令前的斜杠 `/`

---

## 配置问题

### 问题 1：API Key 无效

**症状**：
- 生成图片时显示「API Key 无效」
- 返回 401 或 403 错误

**可能原因**：
- API Key 错误
- API Key 已过期
- API Key 被禁用

**解决方案**：

1. **验证 API Key**：
   ```bash
   curl -X POST "https://ai.gitee.com/v1/images/generations" \
     -H "Authorization: Bearer YOUR_API_KEY" \
     -H "Content-Type: application/json" \
     -d '{
       "model": "z-image-turbo",
       "prompt": "a cat",
       "n": 1,
       "size": "1024x1024"
     }'
   ```

2. **重新获取 API Key**：
   - 登录 [Gitee AI 平台](https://ai.gitee.com)
   - 进入 API 管理页面
   - 删除旧的 API Key
   - 创建新的 API Key

3. **更新配置**：
   - 打开 AstrBot 管理后台
   - 进入插件配置页面
   - 更新 `api_keys` 参数

4. **检查格式**：
   - 确保 API Key 格式正确：`sk-xxxxxxxxxxxxxxxx`
   - 多个 Key 用逗号分隔

---

### 问题 2：API 调用失败

**症状**：
- 生成图片时显示「API 调用失败」
- 返回网络错误或超时

**可能原因**：
- 网络连接问题
- API 服务不可用
- 防火墙阻止
- 代理配置问题

**解决方案**：

1. **检查网络连接**：
   ```bash
   ping ai.gitee.com
   curl https://ai.gitee.com
   ```

2. **检查防火墙**：
   - 确保防火墙允许访问 `ai.gitee.com`
   - 检查端口 443 是否开放

3. **检查代理配置**：
   - 如果使用代理，确保代理配置正确
   - 尝试关闭代理测试

4. **检查 API 服务状态**：
   - 访问 [Gitee AI 状态页面](https://ai.gitee.com)
   - 查看是否有服务公告

5. **增加超时时间**：
   - 在配置中增加请求超时时间（如果支持）

---

### 问题 3：配置保存失败

**症状**：
- 点击「保存」按钮后配置未生效
- 显示「配置保存失败」错误

**可能原因**：
- 配置格式错误
- 必填参数缺失
- 参数值类型错误
- JSON 格式错误

**解决方案**：

1. **检查配置格式**：
   - 确保使用 JSON 格式
   - 检查引号、逗号、括号是否正确

2. **检查必填参数**：
   ```json
   {
     "api_key": ["sk-xxxxxxxxxxxxxxxx"],  
     "model": "z-image-turbo",             
     "size": "1024x1024"                   
   }
   ```

3. **检查参数类型**：
   - `api_key`: 字符串或字符串数组
   - `model`: 字符串
   - `size`: 字符串
   - `num_inference_steps`: 整数
   - `negative_prompt`: 字符串
   - `debug_mode`: 布尔值
   - `download_image_urls`: 布尔值

4. **查看错误信息**：
   - 检查浏览器控制台
   - 查看 AstrBot 日志

5. **重置配置**：
   - 删除插件配置
   - 重新填写配置

---

## 使用问题

### 问题 1：生成图片失败

**症状**：
- 发送生成命令后没有响应
- 显示「生成图片失败」错误

**可能原因**：
- 提示词为空
- 提示词格式错误
- API Key 无效
- 网络问题
- 模型不可用

**解决方案**：

1. **检查提示词**：
   - 确保提示词不为空
   - 检查提示词格式是否正确
   - 尝试使用简单的提示词测试

2. **检查 API Key**：
   - 验证 API Key 是否有效
   - 检查 API Key 是否有剩余额度

3. **检查网络**：
   - 确保网络连接正常
   - 尝试访问 Gitee AI 平台

4. **检查模型**：
   - 确认模型名称正确
   - 尝试切换到其他模型

5. **查看日志**：
   - 打开 AstrBot 管理后台
   - 进入「日志」页面
   - 查找详细的错误信息

---

### 问题 2：图片生成时间过长

**症状**：
- 生成一张图片需要很长时间
- 超过 30 秒仍无响应

**可能原因**：
- 图片尺寸过大
- 模型生成速度慢
- 网络延迟高
- 服务器负载高

**解决方案**：

1. **减小图片尺寸**：
   ```
   # 使用较小的尺寸
   /ai-gitee generate 一只可爱的猫咪 512x512
   ```

2. **切换到快速模型**：
   ```
   /ai-gitee switch-model flux-schnell
   ```

3. **检查网络**：
   - 确保网络连接稳定
   - 尝试使用更快的网络

4. **减少并发请求**：
   - 避免同时发送多个生成请求
   - 等待前一个请求完成后再发送下一个

5. **检查服务器状态**：
   - 查看 Gitee AI 平台是否有服务公告
   - 确认服务器是否正常运行

---

### 问题 3：生成的图片质量不佳

**症状**：
- 图片模糊不清
- 细节不丰富
- 颜色失真
- 主体不清晰

**可能原因**：
- 提示词不够具体
- 质量关键词缺失
- 模型选择不当
- 图片尺寸过小

**解决方案**：

1. **优化提示词**：
   ```
   # 基础提示词
   一只可爱的猫咪
   
   # 优化后的提示词
   一只可爱的橘色猫咪，坐在窗台上，阳光透过窗户洒在它身上，毛茸茸的毛发闪闪发光，背景是蓝天白云，高质量，8K，细节丰富
   ```

2. **添加质量关键词**：
   ```
   a cute cat, high quality, 8K, highly detailed, masterpiece, best quality, ultra detailed
   ```

3. **使用更大的尺寸**：
   ```
   /ai-gitee generate 一只可爱的猫咪 2048x2048
   ```

4. **切换到高质量模型**：
   ```
   /ai-gitee switch-model flux-dev
   ```

5. **描述更多细节**：
   - 描述颜色、光线、纹理
   - 描述场景、氛围
   - 使用具体的形容词

---

### 问题 4：风格转换失败

**症状**：
- 发送风格转换命令后没有响应
- 显示「风格转换失败」错误

**可能原因**：
- 风格名称错误
- 未发送图片
- 图片格式不支持
- API Key 无效

**解决方案**：

1. **检查风格名称**：
   ```
   /ai-gitee style
   ```
   查看所有可用的风格名称

2. **确保发送图片**：
   - 图生图需要同时发送图片
   - 确保图片格式正确（支持 PNG、JPG）

3. **检查图片大小**：
   - 确保图片不超过大小限制
   - 尝试使用较小的图片

4. **验证 API Key**：
   - 确认 API Key 有效
   - 检查 API Key 是否有剩余额度

5. **查看日志**：
   - 打开 AstrBot 管理后台
   - 进入「日志」页面
   - 查找详细的错误信息

---

### 问题 5：AI 编辑失败

**症状**：
- 发送 AI 编辑命令后没有响应
- 显示「AI 编辑失败」错误

**可能原因**：
- 未发送图片
- 提示词为空
- 任务类型错误
- API Key 无效

**解决方案**：

1. **确保发送图片**：
   - AI 编辑必须同时发送图片
   - 支持多张图片编辑

2. **检查提示词**：
   - 确保提示词不为空
   - 描述您想要的编辑效果

3. **检查任务类型**：
   - `id`: 身份编辑
   - `style`: 风格编辑（默认）
   - 确保使用正确的任务类型

4. **验证 API Key**：
   - 确认 API Key 有效
   - 检查 API Key 是否有剩余额度

5. **查看日志**：
   - 打开 AstrBot 管理后台
   - 进入「日志」页面
   - 查找详细的错误信息

---

## 错误代码

### 400 Bad Request

**症状**：
- 返回 400 错误
- 提示「请求参数错误」

**可能原因**：
- 提示词格式错误
- 参数值超出范围
- 必填参数缺失

**解决方案**：

1. **检查提示词格式**：
   - 确保提示词格式正确
   - 避免使用特殊字符

2. **检查参数值**：
   - 确保尺寸在支持范围内
   - 确保模型名称正确

3. **检查必填参数**：
   - 确保所有必填参数都已填写

---

### 401 Unauthorized

**症状**：
- 返回 401 错误
- 提示「未授权」

**可能原因**：
- API Key 无效
- API Key 已过期
- API Key 被禁用

**解决方案**：

1. **验证 API Key**：
   - 使用 curl 测试 API Key
   - 确认 API Key 格式正确

2. **重新获取 API Key**：
   - 登录 Gitee AI 平台
   - 删除旧的 API Key
   - 创建新的 API Key

3. **更新配置**：
   - 在插件配置中更新 API Key

---

### 403 Forbidden

**症状**：
- 返回 403 错误
- 提示「禁止访问」

**可能原因**：
- API Key 权限不足
- API Key 被禁用
- 超出配额限制

**解决方案**：

1. **检查 API Key 权限**：
   - 确认 API Key 有图像生成权限
   - 登录 Gitee AI 平台查看权限设置

2. **检查配额**：
   - 查看 API Key 的剩余额度
   - 确认未超出配额限制

3. **联系客服**：
   - 如果配额不足，联系 Gitee AI 客服
   - 考虑升级套餐

---

### 429 Too Many Requests

**症状**：
- 返回 429 错误
- 提示「请求过多」

**可能原因**：
- 超出速率限制
- 短时间内请求过多

**解决方案**：

1. **等待一段时间**：
   - 等待几分钟后重试
   - 避免短时间内发送多个请求

2. **使用多个 API Key**：
   ```json
   {
     "api_keys": ["sk-xxxxx", "sk-yyyyy", "sk-zzzzz"]
   }
   ```
   插件会自动轮询使用这些 Key

3. **降低请求频率**：
   - 增加请求之间的间隔
   - 避免批量生成

---

### 500 Internal Server Error

**症状**：
- 返回 500 错误
- 提示「服务器内部错误」

**可能原因**：
- 服务器故障
- 模型加载失败
- 临时服务问题

**解决方案**：

1. **等待一段时间**：
   - 服务器可能正在维护
   - 等待几分钟后重试

2. **检查服务状态**：
   - 访问 Gitee AI 平台
   - 查看是否有服务公告

3. **切换模型**：
   ```
   /ai-gitee switch-model z-image-turbo
   ```

4. **联系支持**：
   - 如果问题持续，联系 Gitee AI 支持

---

### 503 Service Unavailable

**症状**：
- 返回 503 错误
- 提示「服务不可用」

**可能原因**：
- 服务器过载
- 服务暂时不可用
- 维护中

**解决方案**：

1. **等待一段时间**：
   - 服务器可能正在维护
   - 等待几分钟后重试

2. **检查服务状态**：
   - 访问 Gitee AI 平台
   - 查看是否有维护公告

3. **稍后再试**：
   - 避免在高峰时段使用
   - 选择非高峰时段生成图片

---

## 性能问题

### 问题 1：生成速度慢

**症状**：
- 生成一张图片需要 30 秒以上
- 多张图片生成时间过长

**可能原因**：
- 图片尺寸过大
- 模型生成速度慢
- 网络延迟高
- 服务器负载高

**解决方案**：

1. **使用较小的尺寸**：
   ```
   # 使用 512x512 而不是 2048x2048
   /ai-gitee generate 一只可爱的猫咪 512x512
   ```

2. **切换到快速模型**：
   ```
   /ai-gitee switch-model flux-schnell
   ```

3. **优化网络**：
   - 使用更快的网络
   - 减少网络延迟

4. **避免高峰时段**：
   - 选择非高峰时段生成图片
   - 避免在服务器负载高时使用

---

### 问题 2：内存占用过高

**症状**：
- AstrBot 内存占用过高
- 系统变慢

**可能原因**：
- 缓存了过多图片
- 并发生成图片过多
- 图片尺寸过大

**解决方案**：

1. **清理缓存**：
   - 定期清理插件缓存
   - 删除不需要的图片

2. **减少并发**：
   - 避免同时发送多个生成请求
   - 等待前一个请求完成后再发送下一个

3. **使用较小的尺寸**：
   - 使用较小的图片尺寸
   - 减少内存占用

4. **重启 AstrBot**：
   - 定期重启 AstrBot
   - 释放内存资源

---

### 问题 3：磁盘空间不足

**症状**：
- 磁盘空间不足
- 无法保存生成的图片

**可能原因**：
- 生成的图片过多
- 缓存未清理
- 临时文件未删除

**解决方案**：

1. **清理旧图片**：
   - 定期删除不需要的图片
   - 清理插件缓存目录

2. **配置自动清理**：
   - 在配置中设置自动清理
   - 限制缓存图片数量

3. **增加磁盘空间**：
   - 清理系统垃圾文件
   - 增加磁盘容量

---

## 调试技巧

### 启用 Debug 模式

启用 Debug 模式可以查看详细的日志信息。

**配置方法**：
```json
{
  "debug_mode": true
}
```

**查看日志**：
- 打开 AstrBot 管理后台
- 进入「日志」页面
- 查看 `[AstrBot-GiteeAI]` 开头的日志

### 验证配置

验证配置是否正确：

1. **检查 API Key**：
   ```bash
   curl -X POST "https://ai.gitee.com/v1/images/generations" \
     -H "Authorization: Bearer YOUR_API_KEY" \
     -H "Content-Type: application/json" \
     -d '{
       "model": "z-image-turbo",
       "prompt": "a cat",
       "n": 1,
       "size": "1024x1024"
     }'
   ```

2. **检查日志**：
   - 查看插件日志
   - 确认配置加载成功

3. **测试命令**：
   ```
   /ai-gitee help
   ```
   确认命令可以正常响应

### 获取详细信息

获取更详细的错误信息：

1. **查看完整日志**：
   - 打开 AstrBot 管理后台
   - 进入「日志」页面
   - 查看完整的错误堆栈

2. **检查网络请求**：
   - 使用浏览器开发者工具
   - 查看网络请求详情

3. **检查 API 响应**：
   - 查看 API 返回的详细错误信息
   - 分析错误原因

## 获取帮助

### 查看文档

- 📖 [快速开始](getting-started.md) - 安装和配置指南
- ⚙️ [配置说明](configuration.md) - 详细的配置选项
- 📚 [使用指南](user-guide.md) - 指令调用方法
- 📐 [支持的图像尺寸](image-sizes.md) - 尺寸和比例详情
- 🖼️ [出图展示区](examples.md) - 生成示例和提示词技巧

### 提问前准备

在提问前，请准备以下信息：

1. **AstrBot 版本**：
   ```
   在 AstrBot 管理后台查看版本号
   ```

2. **插件版本**：
   ```
   在插件管理页面查看版本号
   ```

3. **Python 版本**：
   ```bash
   python --version
   ```

4. **错误信息**：
   - 完整的错误信息
   - 错误堆栈
   - 日志内容

5. **配置信息**：
   - 配置内容（隐藏 API Key）
   - 使用的模型
   - 图片尺寸

6. **复现步骤**：
   - 详细的操作步骤
   - 预期结果
   - 实际结果

### 提问渠道

#### GitHub Issues

在 [GitHub Issues](https://github.com/xiaomizhoubaobei/astrbot_plugin_models_ai/issues) 提问：

1. 搜索现有 Issues
2. 确认问题未被提出
3. 创建新的 Issue
4. 填写详细的问题描述
5. 提供必要的信息

#### QQ 群

加入 QQ 群寻求帮助：

- 1 群：322154837
- 3 群：630166526
- 5 群：822130018
- 6 群：753075035
- 7 群：743746109
- 开发者群：975206796

#### 其他渠道

- 📧 邮件：联系项目维护者
- 💬 Discord：加入 Discord 社区
- 🌐 官网：访问项目官网

### 提问模板

使用以下模板提问可以更快获得帮助：

```
**问题描述**：
简要描述您遇到的问题

**复现步骤**：
1. 第一步...
2. 第二步...
3. 第三步...

**预期结果**：
描述您期望的结果

**实际结果**：
描述实际发生的结果

**环境信息**：
- AstrBot 版本：xxx
- 插件版本：xxx
- Python 版本：xxx
- 操作系统：xxx

**错误信息**：
```
粘贴完整的错误信息
```

**配置信息**：
```
粘贴配置内容（隐藏 API Key）
```

**日志信息**：
```
粘贴相关的日志内容
```

**其他信息**：
其他有用的信息
```

---

## 常见问题 FAQ

### Q: 插件支持哪些模型？

**A**: 插件支持 Gitee AI 平台的所有图像生成模型，包括：
- z-image-turbo（默认）
- flux-schnell
- flux-dev
- sd3
- qwen-image

使用 `/ai-gitee text2image` 命令查看所有可用模型。

---

### Q: 可以使用多个 API Key 吗？

**A**: 可以！在配置中用逗号分隔多个 Key：

```json
{
  "api_keys": ["sk-xxxxx", "sk-yyyyy", "sk-zzzzz"]
}
```

插件会自动轮询使用这些 Key。

---

### Q: 如何提高图片质量？

**A**: 可以通过以下方式提高图片质量：

1. 使用更大的尺寸：`2048x2048`
2. 添加质量关键词：`high quality, 8K, highly detailed`
3. 切换到高质量模型：`flux-dev`
4. 优化提示词：描述更多细节

---

### Q: 支持哪些图片尺寸？

**A**: 插件支持 7 种比例，共 16 种尺寸：

- 1:1: 256x256, 512x512, 1024x1024, 2048x2048
- 4:3: 1152x896, 2048x1536
- 3:4: 768x1024, 1536x2048
- 3:2: 2048x1360
- 2:3: 1360x2048
- 16:9: 1024x576, 2048x1152
- 9:16: 576x1024, 1152x2048

详见[支持的图像尺寸](image-sizes.md)文档。

---

### Q: 如何切换模型？

**A**: 使用以下命令切换模型：

```
/ai-gitee switch-model <模型名称>
```

例如：
```
/ai-gitee switch-model flux-schnell
```

---

### Q: 支持图生图吗？

**A**: 支持！使用以下命令：

```
[发送图片]
/ai-gitee style 手办化
```

或：

```
[发送图片]
/ai-gitee ai-edit 将这张照片转换成油画风格
```

---

### Q: 如何查看可用风格？

**A**: 使用以下命令查看所有可用风格：

```
/ai-gitee style
```

---

### Q: 插件是免费的吗？

**A**: 插件本身是免费的，但使用 Gitee AI 的 API 可能需要付费。Gitee AI 提供一定的免费额度，超出后需要付费。

---

### Q: 如何查看 API 使用情况？

**A**: 登录 Gitee AI 平台，在个人中心可以查看 API 调用次数、剩余额度等信息。

---

### Q: 插件支持哪些平台？

**A**: 插件支持 AstrBot 支持的所有平台，包括：
- QQ
- 企业微信
- 飞书
- 钉钉
- 微信
- Telegram
- Slack
- Discord
- 等

---

### Q: 如何更新插件？

**A**: 通过以下方式更新插件：

1. **插件市场**：
   - 打开 AstrBot 管理后台
   - 进入「插件市场」
   - 找到插件并点击「更新」

2. **手动更新**：
   ```bash
   cd /path/to/AstrBot/data/plugins/astrbot_plugin_models_ai
   git pull
   ```

3. **重新安装**：
   - 删除旧版本
   - 下载最新版本
   - 重新安装

---

### Q: 插件支持批量生成吗？

**A**: 插件本身不支持批量生成，但可以通过多次调用实现：

```
/ai-gitee generate 一只可爱的猫咪
/ai-gitee generate 一只橘色的猫咪
/ai-gitee generate 一只白色的猫咪
```

或者使用脚本自动化批量生成。

---

### Q: 如何配置负面提示词？

**A**: 在插件配置中添加 `negative_prompt` 参数：

```json
{
  "negative_prompt": "low quality, bad anatomy, blurry, watermark, text"
}
```

---

### Q: 插件支持自定义模型吗？

**A**: 插件支持 Gitee AI 平台提供的所有模型。如果平台添加新模型，插件会自动支持。

使用 `/ai-gitee text2image` 命令查看所有可用模型。

---

### Q: 如何启用 Debug 模式？

**A**: 在插件配置中设置：

```json
{
  "debug_mode": true
}
```

启用后可以在日志中看到详细的调试信息。

---

### Q: 插件会保存我的图片吗？

**A**: 插件会临时保存生成的图片，但会定期清理。建议您及时保存需要的图片。

---

### Q: 如何清理缓存？

**A**: 插件会自动清理缓存，您也可以手动清理：

```bash
rm -rf data/plugins/astrbot_plugin_models_ai/temp/*
```

---

### Q: 插件支持代理吗？

**A**: 插件本身不直接支持代理，但可以通过系统代理或环境变量配置。

---

### Q: 如何联系开发者？

**A**: 可以通过以下方式联系开发者：

- GitHub Issues
- QQ 群
- 邮件

详见[获取帮助](#获取帮助)章节。

---

## 相关文档

- 📖 [快速开始](getting-started.md) - 安装和配置指南
- ⚙️ [配置说明](configuration.md) - 详细的配置选项
- 📚 [使用指南](user-guide.md) - 指令调用方法
- 📐 [支持的图像尺寸](image-sizes.md) - 尺寸和比例详情
- 🖼️ [出图展示区](examples.md) - 生成示例和提示词技巧

---

希望本文档能帮助您解决问题！如果仍有疑问，请随时联系我们。🎨✨