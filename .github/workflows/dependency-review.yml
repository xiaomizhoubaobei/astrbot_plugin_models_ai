# Dependency Review Action
#
# 此 Action 将扫描作为 Pull Request 一部分更改的依赖清单文件，
# 暴露 PR 中声明或更新的包的已知易受攻击版本。
# 安装后，如果工作流运行被标记为必需，引入已知易受攻击包的 PR 将被阻止合并。
#
# 源代码仓库: https://github.com/actions/dependency-review-action
# 公共文档: https://docs.github.com/en/code-security/supply-chain-security/understanding-your-software-supply-chain/about-dependency-review#dependency-review-enforcement
name: 'Dependency review'

on:
  pull_request:
    branches: [ "main"]

# 如果在此工作流中使用依赖提交操作，则需要将此权限设置为：
#
# permissions:
#   contents: write
#
# https://docs.github.com/en/enterprise-cloud@latest/code-security/supply-chain-security/understanding-your-software-supply-chain/using-the-dependency-submission-api
permissions:
  contents: read
  # 使用 `comment-summary-in-pr` 选项需要 pull-requests 写权限，如果不使用此选项则注释掉
  pull-requests: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      # 1. 安全加固 Runner
      - name: Harden Runner
        uses: step-security/harden-runner@c6295a65d1254861815972266d5933fd6e532bdf # v2.11.1
        with:
          egress-policy: audit

      # 2. 检出代码
      - name: 'Checkout repository'
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      # 3. 依赖审查
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        # 常用选项，参见 https://github.com/actions/dependency-review-action#configuration-options 获取所有可用选项
        with:
          # 在 PR 中评论摘要
          comment-summary-in-pr: always
          # 严重性级别设置：阻止中等及以上严重性的漏洞
          fail-on-severity: moderate
          # 仅阻止运行时依赖的漏洞（可选：runtime, development, unknown）
          # fail-on-scopes: runtime
          # 拒绝特定许可证（可选）
#          deny-licenses: GPL-1.0-or-later, LGPL-2.0-or-later, AGPL-3.0-or-later
          # 在快照警告时重试
          retry-on-snapshot-warnings: true
          # 执行许可证检查
          license-check: false
          # 执行漏洞检查
          vulnerability-check: true
          # 显示 OpenSSF Scorecard 评分摘要
          show-openssf-scorecard: true
          # OpenSSF Scorecard 评分警告阈值（低于此分数会警告）
          warn-on-openssf-scorecard-level: 6
          # 拒绝特定包（可选）
          # deny-packages: pkg:pypi/pycrypto
          # 拒绝特定包组/命名空间（可选）
          # deny-groups: pkg:pypi/pycrypto/