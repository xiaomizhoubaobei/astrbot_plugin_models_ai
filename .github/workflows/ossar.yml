# 此工作流使用未经 GitHub 认证的 Actions。
# 它们由第三方提供，并受单独的服务条款、隐私政策和支持文档管辖。
#
# 此工作流将开源静态分析工具集合与 GitHub 代码扫描集成。
# 文档或提供反馈，请访问：https://github.com/github/ossar-action
name: OSSAR

on:
  push:
    branches: [ "main"]
  pull_request:
    # 以下分支必须是上述分支的子集
    branches: [ "main"]
  schedule:
    # 每周五 UTC 8:15 运行
    - cron: '15 8 * * 5'
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: read

jobs:
  OSSAR-Scan:
    # OSSAR 在 windows-latest 上运行
    # ubuntu-latest 和 macos-latest 支持即将推出
    permissions:
      contents: read  # 用于 actions/checkout 获取代码
      security-events: write  # 用于 github/codeql-action/upload-sarif 上传 SARIF 结果
      actions: read  # 仅私有仓库需要，用于 github/codeql-action/upload-sarif 获取 Action 运行状态
    runs-on: windows-latest

    steps:
      # 1. 安全加固 Runner
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      # 2. 检出代码
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # 3. 确保安装了兼容版本的 dotnet
      # [Microsoft Security Code Analysis CLI](https://aka.ms/mscadocs) 使用 dotnet v3.1.201 构建
      # 必须在代理上安装大于或等于 v3.1.201 的 dotnet 版本才能运行此操作
      # GitHub 托管的运行器已经安装了兼容版本的 dotnet，可以跳过此步骤
      # 对于自托管运行器，通过包含此操作确保安装 dotnet 版本 3.1.201 或更高版本：
      # - name: Install .NET
      #   uses: actions/setup-dotnet@v4
      #   with:
      #     dotnet-version: '3.1.x'

      # 4. 运行开源静态分析工具
      - name: Run OSSAR
        uses: github/ossar-action@786a16a90ba92b4ae6228fe7382fb16ef5c51000 # v1
        id: ossar

      # 5. 将结果上传到 Security 标签页
      - name: Upload OSSAR results
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        with:
          sarif_file: ${{ steps.ossar.outputs.sarifFile }}